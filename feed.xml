<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="cn"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://peng00bo00.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://peng00bo00.github.io/" rel="alternate" type="text/html" hreflang="cn"/><updated>2024-07-19T09:42:49+00:00</updated><id>https://peng00bo00.github.io/feed.xml</id><title type="html">Bo’s Blog</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">GAMES001课程笔记14-深度学习</title><link href="https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-14/" rel="alternate" type="text/html" title="GAMES001课程笔记14-深度学习"/><published>2024-07-04T00:00:00+00:00</published><updated>2024-07-04T00:00:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-14</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-14/"><![CDATA[<blockquote class="block-preface"> <p>这个系列是GAMES001-图形学中的数学(<a href="https://games-cn.org/games001/">GAMES 001: Mathematics in Computer Graphics</a>)的同步课程笔记。课程旨在总结归纳图形学学习过程中重要的数学概念、理论和方法，并将以索引的形式在每一章节中穿插讲解该数学专题在图形学中的应用。本课程既可以作为GAMES系列其它课程学习的基础或”手册”，也可以作为站在不一样的视角复习图形学知识的平台。本节主要介绍求解深度学习中生成式模型相关的数学知识。</p> </blockquote> <h2 id="深度学习">深度学习</h2> <p>深度学习作为当前最热门的话题之一，已经渗透到计算机科学的各个研究领域中。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/JWUry2U.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/MWJEAik.png" width="100%"/> </div> <p>从数学知识的角度来看，深度学习的基础无非是概率论、线性代数以及数学优化。当然，从学习这些深度学习相关的数学基础到掌握当前最前沿的深度学习模型之间，仍然有非常大的距离。本节课的目标是从当前热门的生成式模型入手，介绍相关的数学知识。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/dt2eppu.png" width="100%"/> </div> <h3 id="损失函数">损失函数</h3> <p>从<a href="/2024/04/10/GAMES001-NOTES-05.html">拟合</a>的角度来看，深度学习的目标是从一系列已知的数据点中学习到一个能够很好拟合这些数据的模型。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/XBkb2XV.png" width="100%"/> </div> <p>我们可以暂时忽略神经网络架构的各种细节，把神经网络视为一个关于参数\(\theta\)的函数\(f_{\theta} (x)\)。这样，模型训练的过程实际上就是最小化关于\(\theta\)的损失函数的过程，通常通过随机梯度下降法来实现。根据不同类型的问题，可以选择相应的损失函数来进行处理。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Z7FX19O.png" width="100%"/> </div> <h3 id="生成式模型">生成式模型</h3> <p>目前，生成式模型是整个AI领域中最为热门的研究方向。从概率的角度来看，每个数据样本都来自于某个概率分布。只要我们能够通过神经网络近似这个分布，就可以通过采样的方式生成新样本。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/24kn3mc.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/xQ6diI9.png" width="100%"/> </div> <p>然而，生成式模型需要回答以下两个问题：</p> <ol> <li>如何度量真实数据分布\(p(x)\)与网络\(\pi_\theta (x)\)之间的相似程度？</li> <li>如何使用神经网络来表示高维数据的分布？</li> </ol> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/KyOsMaO.png" width="100%"/> </div> <p>对于第一个问题，通常可以使用<a href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence">KL散度</a>来进行处理，它度量了\(p\)和\(q\)两个概率分布之间的差异。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/67Njibg.png" width="100%"/> </div> <p>假设\(p\)是一个已知的概率分布，则最小化\(p\)和\(q\)之间KL散度等价于对\(q\)进行最大似然估计。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/484kltM.png" width="100%"/> </div> <h2 id="vae">VAE</h2> <h3 id="隐变量">隐变量</h3> <p>KL散度可以用来解决度量概率分布之间相似度的问题。在此基础上，我们可以利用<a href="https://en.wikipedia.org/wiki/Variational_autoencoder">变分自编码器(VAE)</a>来对概率分布进行建模。VAE是生成式模型中的经典方法，它的核心在于构造一个服从标准正态分布的隐变量\(z \sim N(0, I)\)，且其维度要远小于真实数据\(x\)的维度。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/GT0PBdd.png" width="100%"/> </div> <p>每个数据样本都对应着一个隐变量分布，它们之间的关系可以通过联合概率进行描述。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Xq8gzgM.png" width="100%"/> </div> <p>在VAE模型中，数据分布\(p(x)\)和隐变量分布\(p(z)\)通过<strong>编码器(encoder)</strong>和<strong>解码器(decoder)</strong>关联在一起：</p> <ul> <li>编码器将数据\(x\)映射为隐变量\(z\)，相当于计算条件概率\(p(z \vert x)\)。</li> <li>解码器将隐变量\(z\)重建为数据\(x\)，相当于计算条件概率\(p(x \vert z)\)。</li> </ul> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/os5LrLe.png" width="100%"/> </div> <p>有了条件概率后就可以计算样本数据\(x\)在VAE网络中的概率</p> \[\pi_\theta (x) = \int p_\theta (x \vert z) p (z) \ \mathrm{d} z = \mathbb{E}_{z \sim p(z)} [p_\theta (x \vert z)]\] <p>进而通过最小化KL散度来进行训练。然而，需要注意的是，在计算期望\(\mathbb{E}_{z \sim p(z)} [p_\theta (x \vert z)]\)时需要对\(z\)进行采样，通常需要非常多的样本才能保证计算结果的准确性。除此之外，我们还希望数据\(x\)和隐变量\(z\)之间保持有相对有序的对应关系。因此，需要借助编码器来规范\(z\)的行为。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/09wvIqE.png" width="100%"/> </div> <p>具体来说，在VAE中使用两个神经网络来表示条件概率：</p> <ul> <li>解码器\(D_\theta (z)\)输出\(p_\theta (x \vert z)\)的均值，而\(p_\theta (x \vert z)\)的方差一般规定为1。</li> <li>编码器输出\(q_\phi (z \vert x)\)的均值和方差，这里假定了\(q_\phi (z \vert x)\)服从正太分布</li> </ul> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/ZBtODYG.png" width="100%"/> </div> <p>这样，联合概率分布\(p(x, z)\)就有两种表达方式：</p> <ul> <li>对隐变量\(z\)进行采样并利用解码器有\(p(x, z) = p_\theta (x \vert z) p(z)\)</li> <li>对数据\(x\)进行采样并利用编码器有\(q(x, z) = q_\phi (z \vert x) p (x)\)</li> </ul> <p>两种表示方法对应着同一个分布，因此可以使用KL散度\(D_{KL} (q(x, z) \Vert p(x, z))\)作为损失函数进行训练。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/FBYt3pv.png" width="100%"/> </div> <h3 id="损失函数-1">损失函数</h3> <p>把KL散度进行展开并略去只关于样本分布\(p(x)\)的部分可以得到最终的损失函数为</p> \[L = \mathbb{E}_{z \sim q_\phi (z \vert x_i)} \bigg[ \log{\frac{q_\phi (z \vert x_i)}{p(x_i, z)}} \bigg]\] <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/jq25Sqd.png" width="100%"/> </div> <p>实际上，上面定义的损失函数还对应着\(\log p(x)\)的下界，也即最大似然估计。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Z1Sx5vG.png" width="100%"/> </div> <p>继续对损失函数进行展开，可以将损失函数拆分为两部分：</p> \[L = \mathbb{E}_{z \sim q_\phi (z \vert x_i)} [-\log{p_\theta (x_i \vert z)}] + D_{KL} (q_\phi (z \vert x_i) \Vert p(z))\] <p>其中第一项对应着生成结果与原始数据之间的误差(重建误差)，而第二项对应着两个正态分布之间的KL散度。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/lhspieW.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/3rfe61k.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/hmlNpWm.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/cLJ6Put.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/VRwYr0M.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/I2m6Grt.png" width="100%"/> </div> <h3 id="训练与生成">训练与生成</h3> <p>推导完VAE损失函数后就可以按照通常的神经网络来进行训练。而需要进行生成时只需要从标准正态分布进行采样，并送入解码器来得到新样本。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/lU1FNvf.png" width="100%"/> </div> <p>VAE模型的一个缺陷在于它很难生成高质量的数据。对于图像生成任务，这表现为生成的图片大多比较”糊”。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/B3ObRkt.jpg" width="100%"/> </div> <h2 id="diffusion-model">Diffusion Model</h2> <p>目前火热的<strong>扩散模型(diffusion model)</strong>是最新一代的生成式模型。与VAE相比，扩散模型能够生成更高清、更高质量的图像。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/ptH05lR.jpg" width="100%"/> </div> <p>从数学上来说，扩散模型和VAE之间有许多相通之处。根据上一节的推导，VAE的核心在于建立数据分布和隐变量空间之间的双向映射关系。扩散模型也有类似的思想，不过在扩散模型中，随机噪声分布和数据分布是通过一系列双向映射来实现的。通过这样多步的映射，扩散模型具有更强的表达能力，生成的数据质量也更高。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/IaG3yxU.png" width="100%"/> </div> <h3 id="前向过程">前向过程</h3> <p>扩散模型包括前向和反向两个过程，其中前向过程表示对一张给定的图片添加噪声直至它完全变成无法用肉眼识别的噪声图像。这里每一步添加噪声可以表示为一个马尔科夫链，即第\(t\)步的结果只与上一步\(t-1\)的状态有关。假设在每一步中图像都服从正态分布，则添加噪声的过程可以表示为</p> \[q(x_t \vert x_{t-1}) = N(\sqrt{1 - \beta_t} x_{t-1}, \beta_t I)\] <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/WFghg2M.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/ZzsdESr.png" width="100%"/> </div> <p>利用重参数化的技巧，添加噪声的过程可以表示为</p> \[x_t = \sqrt{\alpha_t} x_{t-1} + \sqrt{1 - \alpha_t} \varepsilon_{t-1}\] <p>其中\(\varepsilon\)表示来自于标准正态分布的随机噪声。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/BcrDPPV.png" width="100%"/> </div> <p>再结合正态分布的性质，我们对\(x_t\)的迭代公式进行展开，最终得到\(x_t\)与初始图像\(x_0\)之间的关系式</p> \[x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \varepsilon_t\] \[\bar{\alpha}_t = \alpha_t \alpha_{t-1} \cdots \alpha_1\] <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/HpfYlfM.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/1oPLF6W.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/xjNRAqL.png" width="100%"/> </div> <p>总结一下，扩散模型的前向过程是一个马尔科夫链，也可以通过一次采样从\(x_0\)直接得到\(x_t\)。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/XTeuLkC.png" width="100%"/> </div> <h3 id="反向过程">反向过程</h3> <p>扩散模型的反向过程是从噪声\(x_t\)中逐步恢复\(x_0\)的过程，其中的每一步都可以使用神经网络来表示反向概率\(p_\theta (x_{t-1} \vert x_t)\)。类似于VAE，我们同样假设\(p_\theta (x_{t-1} \vert x_t)\)是正态分布，其均值由网络给出。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/XBEr4To.png" width="100%"/> </div> <h3 id="损失函数-2">损失函数</h3> <p>扩散模型的损失函数与VAE同样是类似的，不过这里我们需要把单个隐变量\(z\)替换为一系列变量\(x_t\)，…，\(x_1\)。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/rwei8VQ.png" width="100%"/> </div> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/eod4vua.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/TEr0UaC.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/eN3CQVp.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Ne7VuGZ.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Yab3Psz.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/KWSYLPg.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/F3g7N8w.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/t9b0Hpt.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/RvP9Ws5.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/M0P3C0b.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/4Bzwrhk.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/iwG0eED.png" width="100%"/> </div> <h2 id="reference">Reference</h2> <ul> <li><a href="https://www.bilibili.com/video/BV1MF4m1V7e3?p=14&amp;vd_source=7a2542c6c909b3ee1fab551277360826">Lecture 15: 生成模型</a></li> </ul>]]></content><author><name></name></author><category term="GAMES001"/><category term="CG"/><category term="Math"/><summary type="html"><![CDATA[生成式模型背后的数学知识]]></summary></entry><entry><title type="html">GAMES001课程笔记13-优化基础</title><link href="https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-13/" rel="alternate" type="text/html" title="GAMES001课程笔记13-优化基础"/><published>2024-07-03T00:00:00+00:00</published><updated>2024-07-03T00:00:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-13</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-13/"><![CDATA[<blockquote class="block-preface"> <p>这个系列是GAMES001-图形学中的数学(<a href="https://games-cn.org/games001/">GAMES 001: Mathematics in Computer Graphics</a>)的同步课程笔记。课程旨在总结归纳图形学学习过程中重要的数学概念、理论和方法，并将以索引的形式在每一章节中穿插讲解该数学专题在图形学中的应用。本课程既可以作为GAMES系列其它课程学习的基础或”手册”，也可以作为站在不一样的视角复习图形学知识的平台。本节主要介绍求解数学优化的相关技术。</p> </blockquote> <p>数学优化是一个非常广泛且重要的研究领域。从形式上来看，优化问题的目标是最小化一个函数\(f(x)\)。在这个过程中，优化目标函数\(f\)和待优化的变量\(x\)既可以是离散的，也可以是连续的。同时，变量\(x\)还可能需要满足一定的约束条件\(C\)，记为\(x \in C\)。针对不同类型的优化问题，人们设计了各种优化算法来进行求解。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/WTs2m5l.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/LMxJqSf.png" width="100%"/> </div> <h2 id="无约束优化">无约束优化</h2> <p>优化问题中最基础的是无约束优化问题。此时可以令\(C\)为全空间，同时假设\(x \in \mathbb{R}^n\)是连续的向量，且目标函数\(f(x)\)是连续可微的函数。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/OQvhH9f.png" width="100%"/> </div> <p>在这样的框架下，许多问题，例如最小二乘法、曲面参数化以及弹性体仿真等，都可以等价地表示为无约束优化问题。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/FAA7Ty4.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/vlkrNxe.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/73enMta.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/jyDLEJm.png" width="100%"/> </div> <h3 id="线搜索">线搜索</h3> <p><strong>线搜索(line search)</strong>是求解无约束优化的一类经典方法，它的基本思想是从当前位置\(x_k\)出发向\(p_k\)方向移动\(\alpha_k\)步长来逐步最小化目标函数。显然，线搜索方法的核心在于如何确定移动方向\(p_k\)以及步长\(\alpha_k\)这两个量。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/gW9m06U.png" width="100%"/> </div> <h4 id="梯度下降">梯度下降</h4> <p><strong>梯度下降(gradient descent)</strong>是线搜索中最常见的一种方法。在梯度下降算法中，我们选择目标函数的负梯度方向作为前进方向，即\(p_k = -\nabla f (x_k)\)。而要确定移动步长\(\alpha_k\)则相对复杂一些，实践中常使用Armijo条件来进行计算。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/4JAd48J.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/GgE5uGP.png" width="100%"/> </div> <p>结合Armijo条件的梯度下降算法流程可以参考下面ppt。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/KFrlfFW.png" width="100%"/> </div> <h4 id="牛顿迭代">牛顿迭代</h4> <p>梯度下降法只考虑了优化目标函数的一阶信息。为了获得更快的收敛速度，可以结合目标函数的二阶信息，此时得到的算法称为牛顿法。使用牛顿法时，通常要求目标函数在当前位置的Hessian矩阵为正定矩阵。如果Hessian矩阵不是正定的，则需要使用一些额外的方法将其转换为正定矩阵来进行处理。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/DJn7sdz.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/fr0dSrk.png" width="100%"/> </div> <p>牛顿法的算法流程可以参考下面的ppt。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/z82G7YR.png" width="100%"/> </div> <p>与梯度下降法相比，牛顿法通常具有更快的收敛速度，并且可以避免一些震荡的情况。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/0nD7vSJ.png" width="100%"/> </div> <h4 id="拟牛顿法">拟牛顿法</h4> <p>牛顿法的一个缺陷在于每一步迭代中需要计算Hessian矩阵并求解线性方程组来获得前进方向。在某些问题中，这两个步骤可能比较困难且相对耗时。针对这样的问题，我们可以使用一个更容易计算的矩阵\(B_k\)来近似Hessian矩阵，这样的一类方法称为拟牛顿法。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/275ibgv.png" width="100%"/> </div> <p><a href="https://en.wikipedia.org/wiki/Broyden%E2%80%93Fletcher%E2%80%93Goldfarb%E2%80%93Shanno_algorithm#:~:text=In%20numerical%20optimization%2C%20the%20Broyden,the%20gradient%20with%20curvature%20information.">BFGS算法</a>是目前应用最为广泛的一种拟牛顿法。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/DBepGGo.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/W2EIa4b.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/xc3IEAm.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/81RR0W0.png" width="100%"/> </div> <p>BFGS算法的流程可以参考下面的ppt。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/JsaYSWP.png" width="100%"/> </div> <p>在BFGS算法的基础上，进一步发展出了<a href="https://en.wikipedia.org/wiki/Limited-memory_BFGS">L-BFGS算法</a>，旨在降低算法在计算和存储方面的开销。目前，L-BFGS是许多数值计算软件中默认的优化算法。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/JoaB4rD.png" width="100%"/> </div> <h3 id="不动点迭代">不动点迭代</h3> <p>从优化的角度来看，我们之前介绍过的<a href="/2024/06/21/GAMES001-NOTES-12.html#不动点迭代">不动点迭代</a>实际上也是一种拟牛顿法。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/TNSZY3J.png" width="100%"/> </div> <h2 id="带约束优化">带约束优化</h2> <p>对于带约束的优化问题，约束可以分为等式约束以及不等式约束两类。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/kApbxYK.png" width="100%"/> </div> <p>在物理仿真中的常见约束都可以转换为等式约束以及不等式约束。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/COXgyoh.png" width="100%"/> </div> <h3 id="等式约束">等式约束</h3> <p>对于等式约束的情况，我们首先需要考虑在什么情况下目标函数能够达到最优。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/B6iWDDi.png" width="100%"/> </div> <p>以二维情况为例，只有在目标函数的梯度\(\nabla f(x, y)\)与约束\(g(x, y)\)的梯度相互平行时能够达到最优，即\(\nabla f = \lambda \nabla g\)。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/5buopvh.png" width="100%"/> </div> <p>根据上面的分析可以得到等式约束条件下最优点\(x^*\)需要满足的条件：</p> \[g_i(x^*) = 0\] \[\nabla f(x^*) = \sum_i \lambda_i \nabla g_i (x^*)\] <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/n5bsPpo.png" width="100%"/> </div> <h4 id="拉格朗日乘子法">拉格朗日乘子法</h4> <p>更进一步，等式约束条件的最优化问题可以利用<a href="https://en.wikipedia.org/wiki/Lagrange_multiplier">拉格朗日乘子</a>进行处理。我们定义原始优化问题的拉格朗日函数为</p> \[L(x, \lambda_1, ..., \lambda_n) = f(x) - \sum_i \lambda_i g_i (x)\] <p>则等式约束的最优解可以表示为</p> \[\nabla L = 0\] <p>这样约束优化问题就通过拉格朗日乘子转换为了无约束优化问题。然而，需要注意的是仅通过最小化\(L\)并不能保证得到问题的解，还必须确保\(g_i (x) = 0\)始终成立。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/0BIa5C9.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/8iv1JeF.png" width="100%"/> </div> <h4 id="min-max问题">Min-Max问题</h4> <p>实际上，与原始约束优化问题等价的拉格朗日优化问题是一个Min-Max问题：</p> \[\min_x \max_{\lambda_i} L(x, \lambda_1, ..., \lambda_n)\] <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/TJwiUyJ.png" width="100%"/> </div> <p>对于Min-Max问题，我们无法直接使用前面介绍过的无约束优化方法进行求解。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/PdkIdqi.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/lkjae3m.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/bJSJ9QX.png" width="100%"/> </div> <h4 id="对偶问题">对偶问题</h4> <p>直接求解Min-Max问题往往效率较低。在实践中，通常会将Min-Max问题转换为其对偶问题进行处理。这时需要交换最大化和最小化的顺序，先对\(x\)进行最小化，然后对\(\lambda\)进行最大化，从而将Min-Max问题转化为Max-Min问题。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/SkVlcRH.png" width="100%"/> </div> <p>对于一般的函数\(L(x, \lambda)\)，可以证明对偶问题是原始问题的下界，这称为弱对偶关系。而对于凸函数，可以证明原始问题和对偶问题是等价的，称为强对偶条件。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/QuC5bIq.png" width="100%"/> </div> <p>假设强对偶条件成立，则可以使用无约束优化问题的相关求解方法进行处理。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Hm9Jswk.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/jr8zxod.png" width="100%"/> </div> <h4 id="对偶上升法">对偶上升法</h4> <p>对于对偶问题，我们可以使用对偶上升法交替更新\(x\)和\(\lambda\)进行求解。对偶上升法将原始的约束优化问题转换为了两个无约束优化问题，在优化\(\lambda\)时可以利用梯度下降法进行处理。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/EelKXj3.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/JFo3pwr.png" width="100%"/> </div> <h4 id="罚函数法">罚函数法</h4> <p>除了拉格朗日乘子法之外，对于等式约束的优化问题还可以使用罚函数法。其基本思想是将等式约束视为一个惩罚项，当\(x\)违反约束时施加相应的惩罚来约束\(x\)。然而，罚函数法无法保证约束一定能够严格满足，只能保证近似满足。实践中一般需要调节惩罚项系数\(\mu\)来保证优化能够收敛。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/aBswLUb.png" width="100%"/> </div> <h3 id="不等式约束">不等式约束</h3> <p>带有不等式约束的优化问题处理起来比等式约束更加复杂。关键在于，不等式约束只有在变成等式约束时才会直接影响最优解；否则，不等式约束相当于不起作用，此时可以按照无约束优化进行处理。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/yNiBb1t.png" width="100%"/> </div> <p>对于一般形式的不等式约束优化问题，我们同样可以定义拉格朗日函数并推导相应的对偶问题以及对偶优化算法。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Izia8C3.png" width="100%"/> </div> <h2 id="reference">Reference</h2> <ul> <li><a href="https://www.bilibili.com/video/BV1MF4m1V7e3?p=15&amp;vd_source=7a2542c6c909b3ee1fab551277360826">Lecture 14: 优化基础</a></li> </ul>]]></content><author><name></name></author><category term="GAMES001"/><category term="CG"/><category term="Math"/><summary type="html"><![CDATA[图形学中常用的优化方法]]></summary></entry><entry><title type="html">GAMES001课程笔记12-线性系统</title><link href="https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-12/" rel="alternate" type="text/html" title="GAMES001课程笔记12-线性系统"/><published>2024-06-21T00:00:00+00:00</published><updated>2024-06-21T00:00:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-12</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/GAMES001-NOTES-12/"><![CDATA[<blockquote class="block-preface"> <p>这个系列是GAMES001-图形学中的数学(<a href="https://games-cn.org/games001/">GAMES 001: Mathematics in Computer Graphics</a>)的同步课程笔记。课程旨在总结归纳图形学学习过程中重要的数学概念、理论和方法，并将以索引的形式在每一章节中穿插讲解该数学专题在图形学中的应用。本课程既可以作为GAMES系列其它课程学习的基础或”手册”，也可以作为站在不一样的视角复习图形学知识的平台。本节主要介绍求解线性系统的相关技术。</p> </blockquote> <p>求解线性系统实际上就是解矩阵方程</p> \[\mathbf{A} \boldsymbol{x} = \mathbf{b}\] <p>在图形学的各个研究方向中，许多问题的本质就是求解一个线性系统。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/z9uR9SM.png" width="100%"/> </div> <h2 id="直接求解">直接求解</h2> <h3 id="高斯消元">高斯消元</h3> <p>求解线性系统的基本方法是直接进行求解，其中<a href="https://en.wikipedia.org/wiki/Gaussian_elimination">高斯消元法</a>是这类方法的典型代表。具体来说，高斯消元法会同时对系数矩阵\(\mathbb{A}\)和向量\(\mathbf{b}\)进行行变换，使得矩阵\(\mathbb{A}\)变成一个上三角矩阵。得到上三角矩阵后即可从下往上反向回代计算出解\(\boldsymbol{x}\)。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/oOZZ6q2.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/4CHiPgb.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/1CVjWRz.png" width="100%"/> </div> <p>换个角度来看，矩阵的行变换等价于左乘一个下三角矩阵。因此，高斯消元法可以理解为对矩阵进行<a href="https://en.wikipedia.org/wiki/LU_decomposition">LU分解</a>。通过LU分解，我们将系数矩阵\(\mathbf{A}\)分解为一个下三角矩阵\(\mathbf{L}\)和一个上三角矩阵\(\mathbf{U}\)的乘积。然后，通过求解两个较简单的线性系统\(\mathbf{L} \mathbf{y} = \mathbf{b}\)和\(\mathbf{U} \boldsymbol{x} = \mathbf{y}\)就可以得到最终解\(\boldsymbol{x}\)。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/MDCebWs.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/PWnsVgm.png" width="100%"/> </div> <p>从编程的角度来讲，高斯消元法的核心在于计算矩阵的LU分解，其伪代码可以参考下方ppt。显然LU分解的复杂度为\(O(n^3)\)，因此LU分解是一个复杂度比较高的算法，不过可以利用一些并行的方法来进行加速。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/lUdfUoQ.png" width="100%"/> </div> <p>使用高斯消元法时还需要注意，如果当前选择的对角线元素值接近0时会产生数值计算上的不稳定。为了处理这种情况，可以考虑每次都选择当前列中绝对值最大的那一行作为主元，然后再利用主元来消去其它行。这种带选择主元的高斯消元法也称为列主元高斯消元法或部分主元高斯消元法(Gaussian Elimination with Partial Pivoting, GEPP)。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/BPOKxPg.png" width="100%"/> </div> <h3 id="cholesky分解">Cholesky分解</h3> <p>对于对称半正定的系数矩阵，LU分解可以简化为<a href="https://en.wikipedia.org/wiki/Cholesky_decomposition">Cholesky分解</a>。此时，系数矩阵\(\mathbf{A}\)可以表示为下三角矩阵\(\mathbf{A}\)与其自身转置\(\mathbf{A}^T\)的乘积。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Fo6uU0D.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/OPsneo2.png" width="100%"/> </div> <p>Cholesky分解的伪代码可以参考下方ppt。类似于LU分解，Cholesky分解的复杂度同样是\(O(n^3)\)，也可以利用一些并行的技术来进行加速。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/dciPYSX.png" width="100%"/> </div> <p>简单总结一下，LU分解以及高斯消元法可以求解任意的矩阵方程，而Cholesky分解则只适用于对称半正定的系统。由于这两种方法都具有\(O(n^3)\)的复杂度，它们只适合一些规模比较小的线性系统。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/ARqmPdk.png" width="100%"/> </div> <h2 id="迭代求解">迭代求解</h2> <p>对于更大规模的线性系统，我们通常会使用迭代法来求解。迭代法的基本框架是从一个初始解\(x^0\)出发，反复执行某个步骤来更新当前解</p> \[x^{k+1} \leftarrow \Psi (x^k)\] <p>迭代过程会继续直到满足设定的迭代次数上限，或者达到一定的残差收敛条件。相较于直接法，迭代法的优势在于可以在任意迭代步骤中得到精度满足要求的近似解，而不需要等到整个算法结束才能终止。在许多应用场景中，仅需一个近似解即可满足需求。同时，一个好的初始解\(x^0\)往往可以极大地减少迭代次数。因此对于特定问题优化的迭代算法有着远高于直接求解的效率。除此之外，迭代法甚至可以推广到系数矩阵\(\mathbf{A}\)没有显式给出的情况。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/SjBJZO3.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/YS8P1us.png" width="100%"/> </div> <h3 id="不动点迭代">不动点迭代</h3> <p>首先我们来介绍<a href="https://en.wikipedia.org/wiki/Fixed-point_iteration">不动点迭代</a>。举个简单的例子，假设要求解方程</p> \[x = \cos{x}\] <p>我们可以建立迭代格式</p> \[x^{k+1} \leftarrow \cos{x^k}\] <p>通过不断执行可以发现\(\boldsymbol{x}\)会收敛到某个值上，而实际上这个值就是方程的解。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/fjXgdF9.png" width="100%"/> </div> <p>在线性系统的求解中，可以利用不动点迭代方法来进行计算。我们可以将系数矩阵\(\mathbf{A}\)表示为</p> \[\mathbf{A} = \mathbf{M} - \mathbf{N}\] <p>这样线性系统的解可以表示为</p> \[\boldsymbol{x} = \mathbf{M}^{-1} (\mathbf{N} \boldsymbol{x} + \mathbf{b})\] <p>从而建立迭代格式</p> \[\boldsymbol{x}^{k+1} \leftarrow \mathbf{M}^{-1} (\mathbf{N} \boldsymbol{x}^k + \mathbf{b})\] <p>如果迭代能够收敛，则可以保证\(\boldsymbol{x}^k\)会趋向于线性系统的解。以上就是不动点迭代求解线性系统的基本思想，当然使用不动点迭代时还有很多问题需要考虑，比如如何计算逆阵\(\mathbf{M}^{-1}\)、如何保证迭代收敛以及迭代的效率等。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/pEcNTUk.png" width="100%"/> </div> <h4 id="jacobi迭代">Jacobi迭代</h4> <p><a href="https://en.wikipedia.org/wiki/Jacobi_method">Jacobi迭代</a>是一种典型的不动点迭代法。在Jacobi迭代中，我们取\(\mathbf{M}\)矩阵为系数矩阵\(\mathbf{A}\)的对角元素\(\mathbf{D}\)，则\(\mathbf{N}\)矩阵为系数矩阵\(\mathbf{A}\)的其余非对角元素的相反数。此时\(\mathbf{M}^{-1}\)为对角元素的倒数，因此每次迭代都只需要进行基本的矩阵乘法和加法运算。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/RiGG3Vf.png" width="100%"/> </div> <p>Jacobi迭代的伪代码可以参考如下。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/gAHtQpS.png" width="100%"/> </div> <p>需要注意的是，在某些情况下Jacobi迭代可能会出现不收敛的情况。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/MMyen8l.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/eGUtxaa.png" width="100%"/> </div> <p>要分析不动点迭代法的收敛准则，我们需要引入”误差”的概念。这里”误差”是指当前解\(\boldsymbol{x}^k\)与真实解\(\boldsymbol{x}^*\)之间的差。误差\(\boldsymbol{e}^k\)与残差\(\boldsymbol{r}^k\)之间的关系为</p> \[\boldsymbol{r}^k = \mathbf{b} - \mathbf{A} \boldsymbol{x}^k = \mathbf{A} (\boldsymbol{x}^* - \boldsymbol{x}^k) = \mathbf{A} \boldsymbol{e}^k\] <p>显然，随着迭代的进行误差\(\boldsymbol{e}^k\)具有递推关系</p> \[\boldsymbol{e}^{k+1} \leftarrow (\mathbf{I} - \mathbf{M}^{-1} \mathbf{A}) \boldsymbol{e}^k = \mathbf{M}^{-1} \mathbf{N} \boldsymbol{e}^k\] <p>上式说明，在每一次迭代时误差更新相当于左乘一个矩阵\(\mathbf{T}\)</p> \[\mathbf{T} = \mathbf{I} - \mathbf{M}^{-1} \mathbf{A} = \mathbf{M}^{-1} \mathbf{N}\] <p>只有当矩阵\(\mathbf{T}\)的<a href="https://en.wikipedia.org/wiki/Spectral_radius">谱半径</a>小于1时误差才能保证收敛，否则误差可能会不收敛。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/pr5Jexx.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/heYQMed.png" width="100%"/> </div> <p>在Jacobi迭代中，如果系数矩阵\(\mathbf{A}\)是严格对角占优的则可以保证迭代一定可以收敛。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/N9cgJ7b.png" width="100%"/> </div> <p>如果系数矩阵是非对角占优的，还可以通过松弛的方法使得Jacobi迭代能够收敛。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/UYPMyty.png" width="100%"/> </div> <p>总结来说，Jacobi迭代是一种简单实现且适合并行计算的迭代求解算法。然而，实践经验表明Jacobi迭代通常需要较多的迭代步数才能达到收敛。当系数矩阵接近对角占优时，Jacobi迭代的收敛速度会明显加快。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/DfgxHsF.png" width="100%"/> </div> <h4 id="gauss-seidel迭代">Gauss-Seidel迭代</h4> <p>除了Jacobi迭代，另一种常用的迭代算法是<a href="https://en.wikipedia.org/wiki/Gauss%E2%80%93Seidel_method">Gauss-Seidel迭代</a>。和Jacobi迭代相比，Gauss-Seidel迭代在构造\(\mathbf{M}\)矩阵时使用了系数矩阵的对角元以及下三角部分，此时计算\(\mathbf{M}^{-1}\)可以使用类似与高斯消元法的方式进行处理。由于这样构造的\(\mathbf{M}\)矩阵更接近与系数矩阵\(\mathbf{A}\)，因此Gauss-Seidel迭代通常具有比Jacobi迭代更快的收敛速度和更高的收敛效率。特别值得注意的是，Gauss-Seidel迭代的收敛充分但不是必要条件是系数矩阵\(\mathbf{A}\)为对称半正定矩阵。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Ve9Rapu.png" width="100%"/> </div> <p>从代码实现的角度来看，Gauss-Seidel迭代和Jacobi迭代的唯一区别在于更新当前解\(\boldsymbol{x}^{k+1}\)时是否使用已经更新过的结果。Gauss-Seidel迭代会利用当前步中已经更新过的计算结果，而Jacobi迭代只会利用上一步的结果。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/ubDv1MH.png" width="100%"/> </div> <p>两种不动点迭代方法的优劣可以总结如下。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/2soxW41.png" width="100%"/> </div> <h3 id="子空间迭代">子空间迭代</h3> <p>除了前面介绍的不动点迭代方法，另一种常用的迭代求解线性系统的方法为子空间迭代法。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/MlERVme.png" width="100%"/> </div> <p>子空间迭代法中最常用的方法是<a href="https://en.wikipedia.org/wiki/Krylov_subspace">Krylov子空间迭代法</a>。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/XbJEgEj.png" width="100%"/> </div> <p>在Krylov子空间的基础上，对于对称半正定系数矩阵的情况我们可以推导<a href="https://en.wikipedia.org/wiki/Conjugate_gradient_method">共轭梯度下降法</a>。其基本思路是将求解矩阵方程\(\mathbf{A} \boldsymbol{x} = \mathbf{b}\)转化为一个最优化问题：</p> \[\min f(\boldsymbol{x}) = \frac{1}{2} \boldsymbol{x}^T \mathbf{A} \boldsymbol{x} - \mathbf{b}^T \boldsymbol{x}\] <p>而优化目标函数的梯度为</p> \[\nabla f = \mathbf{A} \boldsymbol{x} - \mathbf{b} = - \boldsymbol{r}\] <p>共轭梯度法的核心思想是在每次迭代中，将当前的搜索方向与之前的搜索方向正交化(即共轭)，从而在Krylov子空间 \(K_m\)中进行优化。这个子空间是由初始残差和迭代过程中生成的搜索方向构成的。假设我们能够构造出Krylov子空间的一组基\(K_m = \text{span} \{ \boldsymbol{p}_1, ..., \boldsymbol{p}_m \}\)，它们满足共轭条件：</p> \[\boldsymbol{p}_i^T \mathbf{A} \boldsymbol{p}_j = 0\] <p>则在每一步更新\(\boldsymbol{x}_m\)时只需在当前的基上进行移动：</p> \[\boldsymbol{x}_m = \boldsymbol{x}_{m-1} + \alpha_m \boldsymbol{p}_m\] <p>其中步长\(\alpha_m\)可以显式求解。可以证明，只要能够构造出一组共轭基\(K_m = \text{span} \{ \boldsymbol{p}_1, ..., \boldsymbol{p}_m \}\)，共轭梯度法是可以运行下去的。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/XT58RZk.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/nWNDdII.png" width="100%"/> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/Gy79XVV.png" width="100%"/> </div> <p>使用共轭梯度法求解矩阵方程的伪代码可以参考下方ppt。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/J3uIKlW.png" width="100%"/> </div> <p>需要额外说明的是，共轭梯度法的收敛速度取决于系数矩阵\(\mathbf{A}\)的条件数，条件数越接近于1收敛的速度就越快。因此在使用共轭梯度法时往往还会进行一些预处理，以改善条件数并加快收敛速度。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/eSWalkX.png" width="100%"/> </div> <p>当然，除了共轭梯度法之外基于Krylov子空间还有一些其它的线性系统求解方法，它们可以适用于非对称正定矩阵的情况。</p> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/xLLvNUT.png" width="100%"/> </div> <div align="center"> <img src="https://search.pstatic.net/common?src=https://i.imgur.com/PMa7SsU.png" width="100%"/> </div> <h2 id="reference">Reference</h2> <ul> <li><a href="https://www.bilibili.com/video/BV1MF4m1V7e3?p=13&amp;vd_source=7a2542c6c909b3ee1fab551277360826">Lecture 13: 线性系统</a></li> </ul>]]></content><author><name></name></author><category term="GAMES001"/><category term="CG"/><category term="Math"/><summary type="html"><![CDATA[求解线性系统的相关技术]]></summary></entry><entry><title type="html">a post with tabs</title><link href="https://peng00bo00.github.io/blog/2024/tabs/" rel="alternate" type="text/html" title="a post with tabs"/><published>2024-05-01T00:32:13+00:00</published><updated>2024-05-01T00:32:13+00:00</updated><id>https://peng00bo00.github.io/blog/2024/tabs</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/tabs/"><![CDATA[<p>This is how a post with <a href="https://github.com/Ovski4/jekyll-tabs">tabs</a> looks like. Note that the tabs could be used for different purposes, not only for code.</p> <h2 id="first-tabs">First tabs</h2> <p>To add tabs, use the following syntax:</p> <div class="language-liquid highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cp">{%</span><span class="w"> </span><span class="nt">tabs</span><span class="w"> </span><span class="nv">group-name</span><span class="w"> </span><span class="cp">%}</span>

<span class="cp">{%</span><span class="w"> </span><span class="nt">tab</span><span class="w"> </span><span class="nv">group-name</span><span class="w"> </span><span class="nv">tab-name-1</span><span class="w"> </span><span class="cp">%}</span>

Content 1

<span class="cp">{%</span><span class="w"> </span><span class="nt">endtab</span><span class="w"> </span><span class="cp">%}</span>

<span class="cp">{%</span><span class="w"> </span><span class="nt">tab</span><span class="w"> </span><span class="nv">group-name</span><span class="w"> </span><span class="nv">tab-name-2</span><span class="w"> </span><span class="cp">%}</span>

Content 2

<span class="cp">{%</span><span class="w"> </span><span class="nt">endtab</span><span class="w"> </span><span class="cp">%}</span>

<span class="cp">{%</span><span class="w"> </span><span class="nt">endtabs</span><span class="w"> </span><span class="cp">%}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>With this you can generate visualizations like:</p> <ul id="log" class="tab" data-tab="b1f3f38e-e0dc-4201-8a33-b4be43c5697c" data-name="log"> <li class="active" id="log-php"> <a href="#">php </a> </li> <li id="log-js"> <a href="#">js </a> </li> <li id="log-ruby"> <a href="#">ruby </a> </li> </ul> <ul class="tab-content" id="b1f3f38e-e0dc-4201-8a33-b4be43c5697c" data-name="log"> <li class="active"> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">var_dump</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div> </li> <li> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div> </li> <li> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">pputs</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span>
</pre></td></tr></tbody></table></code></pre></div></div> </li> </ul> <h2 id="another-example">Another example</h2> <ul id="data-struct" class="tab" data-tab="8657f2b4-af2c-4dd9-ad34-14cb36b17f7e" data-name="data-struct"> <li class="active" id="data-struct-yaml"> <a href="#">yaml </a> </li> <li id="data-struct-json"> <a href="#">json </a> </li> </ul> <ul class="tab-content" id="8657f2b4-af2c-4dd9-ad34-14cb36b17f7e" data-name="data-struct"> <li class="active"> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="na">hello</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">whatsup"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">hi"</span>
</pre></td></tr></tbody></table></code></pre></div></div> </li> <li> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"hello"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"whatsup"</span><span class="p">,</span><span class="w"> </span><span class="s2">"hi"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div> </li> </ul> <h2 id="tabs-for-something-else">Tabs for something else</h2> <ul id="something-else" class="tab" data-tab="7c3d8115-5048-4500-8cec-f508d325d7ac" data-name="something-else"> <li class="active" id="something-else-text"> <a href="#">text </a> </li> <li id="something-else-quote"> <a href="#">quote </a> </li> <li id="something-else-list"> <a href="#">list </a> </li> </ul> <ul class="tab-content" id="7c3d8115-5048-4500-8cec-f508d325d7ac" data-name="something-else"> <li class="active"> <p>Regular text</p> </li> <li> <blockquote> <p>A quote</p> </blockquote> </li> <li> <p>Hipster list</p> <ul> <li>brunch</li> <li>fixie</li> <li>raybans</li> <li>messenger bag</li> </ul> </li> </ul>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="code"/><summary type="html"><![CDATA[this is what included tabs in a post could look like]]></summary></entry><entry><title type="html">a post with typograms</title><link href="https://peng00bo00.github.io/blog/2024/typograms/" rel="alternate" type="text/html" title="a post with typograms"/><published>2024-04-29T23:36:10+00:00</published><updated>2024-04-29T23:36:10+00:00</updated><id>https://peng00bo00.github.io/blog/2024/typograms</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/typograms/"><![CDATA[<p>This is an example post with some <a href="https://github.com/google/typograms/">typograms</a> code.</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">```</span><span class="nl">typograms
</span><span class="sb">+----+
|    |---&gt; My first diagram!
+----+</span>
<span class="p">```</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Which generates:</p> <pre><code class="language-typograms">+----+
|    |---&gt; My first diagram!
+----+
</code></pre> <p>Another example:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="p">```</span><span class="nl">typograms
</span><span class="sb">.------------------------.
|.----------------------.|
||"https://example.com" ||
|'----------------------'|
| ______________________ |
||                      ||
||   Welcome!           ||
||                      ||
||                      ||
||  .----------------.  ||
||  | username       |  ||
||  '----------------'  ||
||  .----------------.  ||
||  |"*******"       |  ||
||  '----------------'  ||
||                      ||
||  .----------------.  ||
||  |   "Sign-up"    |  ||
||  '----------------'  ||
||                      ||
|+----------------------+|
.------------------------.</span>
<span class="p">```</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>which generates:</p> <pre><code class="language-typograms">.------------------------.
|.----------------------.|
||"https://example.com" ||
|'----------------------'|
| ______________________ |
||                      ||
||   Welcome!           ||
||                      ||
||                      ||
||  .----------------.  ||
||  | username       |  ||
||  '----------------'  ||
||  .----------------.  ||
||  |"*******"       |  ||
||  '----------------'  ||
||                      ||
||  .----------------.  ||
||  |   "Sign-up"    |  ||
||  '----------------'  ||
||                      ||
|+----------------------+|
.------------------------.
</code></pre> <p>For more examples, check out the <a href="https://google.github.io/typograms/#examples">typograms documentation</a>.</p>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="diagrams"/><summary type="html"><![CDATA[this is what included typograms code could look like]]></summary></entry><entry><title type="html">a post that can be cited</title><link href="https://peng00bo00.github.io/blog/2024/post-citation/" rel="alternate" type="text/html" title="a post that can be cited"/><published>2024-04-28T15:06:00+00:00</published><updated>2024-04-28T15:06:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/post-citation</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/post-citation/"><![CDATA[<p>This is an example post that can be cited. The content of the post ends here, while the citation information is automatically provided below. The only thing needed is for you to set the <code class="language-plaintext highlighter-rouge">citation</code> key in the front matter to <code class="language-plaintext highlighter-rouge">true</code>.</p>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="citation"/><summary type="html"><![CDATA[this is what a post that can be cited looks like]]></summary></entry><entry><title type="html">a post with pseudo code</title><link href="https://peng00bo00.github.io/blog/2024/pseudocode/" rel="alternate" type="text/html" title="a post with pseudo code"/><published>2024-04-15T00:01:00+00:00</published><updated>2024-04-15T00:01:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/pseudocode</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/pseudocode/"><![CDATA[<p>This is an example post with some pseudo code rendered by <a href="https://github.com/SaswatPadhi/pseudocode.js">pseudocode</a>. The example presented here is the same as the one in the <a href="https://saswat.padhi.me/pseudocode.js/">pseudocode.js</a> documentation, with only one simple but important change: everytime you would use <code class="language-plaintext highlighter-rouge">$</code>, you should use <code class="language-plaintext highlighter-rouge">$$</code> instead. Also, note that the <code class="language-plaintext highlighter-rouge">pseudocode</code> key in the front matter is set to <code class="language-plaintext highlighter-rouge">true</code> to enable the rendering of pseudo code. As an example, using this code:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="p">```</span><span class="nl">pseudocode
</span><span class="sb">% This quicksort algorithm is extracted from Chapter 7, Introduction to Algorithms (3rd edition)
\begin{algorithm}
\caption{Quicksort}
\begin{algorithmic}
\PROCEDURE{Quicksort}{$$A, p, r$$}
    \IF{$$p &lt; r$$}
        \STATE $$q = $$ \CALL{Partition}{$$A, p, r$$}
        \STATE \CALL{Quicksort}{$$A, p, q - 1$$}
        \STATE \CALL{Quicksort}{$$A, q + 1, r$$}
    \ENDIF
\ENDPROCEDURE
\PROCEDURE{Partition}{$$A, p, r$$}
    \STATE $$x = A[r]$$
    \STATE $$i = p - 1$$
    \FOR{$$j = p$$ \TO $$r - 1$$}
        \IF{$$A[j] &lt; x$$}
            \STATE $$i = i + 1$$
            \STATE exchange
            $$A[i]$$ with $$A[j]$$
        \ENDIF
        \STATE exchange $$A[i]$$ with $$A[r]$$
    \ENDFOR
\ENDPROCEDURE
\end{algorithmic}
\end{algorithm}</span>
<span class="p">```</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Generates:</p> <pre><code class="language-pseudocode">% This quicksort algorithm is extracted from Chapter 7, Introduction to Algorithms (3rd edition)
\begin{algorithm}
\caption{Quicksort}
\begin{algorithmic}
\PROCEDURE{Quicksort}{$$A, p, r$$}
    \IF{$$p &lt; r$$}
        \STATE $$q = $$ \CALL{Partition}{$$A, p, r$$}
        \STATE \CALL{Quicksort}{$$A, p, q - 1$$}
        \STATE \CALL{Quicksort}{$$A, q + 1, r$$}
    \ENDIF
\ENDPROCEDURE
\PROCEDURE{Partition}{$$A, p, r$$}
    \STATE $$x = A[r]$$
    \STATE $$i = p - 1$$
    \FOR{$$j = p$$ \TO $$r - 1$$}
        \IF{$$A[j] &lt; x$$}
            \STATE $$i = i + 1$$
            \STATE exchange
            $$A[i]$$ with $$A[j]$$
        \ENDIF
        \STATE exchange $$A[i]$$ with $$A[r]$$
    \ENDFOR
\ENDPROCEDURE
\end{algorithmic}
\end{algorithm}
</code></pre>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="code"/><summary type="html"><![CDATA[this is what included pseudo code could look like]]></summary></entry><entry><title type="html">a post with code diff</title><link href="https://peng00bo00.github.io/blog/2024/code-diff/" rel="alternate" type="text/html" title="a post with code diff"/><published>2024-01-27T19:22:00+00:00</published><updated>2024-01-27T19:22:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/code-diff</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/code-diff/"><![CDATA[<p>You can display diff code by using the regular markdown syntax:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">```</span><span class="nl">diff
</span><span class="gh">diff --git a/sample.js b/sample.js
index 0000001..0ddf2ba
</span><span class="gd">--- a/sample.js
</span><span class="gi">+++ b/sample.js
</span><span class="p">@@ -1 +1 @@</span>
<span class="gd">-console.log("Hello World!")
</span><span class="gi">+console.log("Hello from Diff2Html!")</span>
<span class="p">```</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Which generates:</p> <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="gh">diff --git a/sample.js b/sample.js
index 0000001..0ddf2ba
</span><span class="gd">--- a/sample.js
</span><span class="gi">+++ b/sample.js
</span><span class="p">@@ -1 +1 @@</span>
<span class="gd">-console.log("Hello World!")
</span><span class="gi">+console.log("Hello from Diff2Html!")
</span></pre></td></tr></tbody></table></code></pre></div></div> <p>But this is difficult to read, specially if you have a large diff. You can use <a href="https://diff2html.xyz/">diff2html</a> to display a more readable version of the diff. For this, just use <code class="language-plaintext highlighter-rouge">diff2html</code> instead of <code class="language-plaintext highlighter-rouge">diff</code> for the code block language:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">```</span><span class="nl">diff2html
</span><span class="sb">diff --git a/sample.js b/sample.js
index 0000001..0ddf2ba
--- a/sample.js
+++ b/sample.js
@@ -1 +1 @@
-console.log("Hello World!")
+console.log("Hello from Diff2Html!")</span>
<span class="p">```</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>If we use a longer example, for example <a href="https://github.com/rtfpessoa/diff2html/commit/c2c253d3e3f8b8b267f551e659f72b44ca2ac927">this commit from diff2html</a>, it will generate the following output:</p> <pre><code class="language-diff2html">From 2aaae31cc2a37bfff83430c2c914b140bee59b6a Mon Sep 17 00:00:00 2001
From: Rodrigo Fernandes &lt;rtfrodrigo@gmail.com&gt;
Date: Sun, 9 Oct 2016 16:41:54 +0100
Subject: [PATCH 1/2] Initial template override support

---
 scripts/hulk.js                    |  4 ++--
 src/diff2html.js                   |  3 +--
 src/file-list-printer.js           | 11 ++++++++---
 src/hoganjs-utils.js               | 29 +++++++++++++++++------------
 src/html-printer.js                |  6 ++++++
 src/line-by-line-printer.js        |  6 +++++-
 src/side-by-side-printer.js        |  6 +++++-
 test/file-list-printer-tests.js    |  2 +-
 test/hogan-cache-tests.js          | 18 +++++++++++++++---
 test/line-by-line-tests.js         |  3 +--
 test/side-by-side-printer-tests.js |  3 +--
 11 files changed, 62 insertions(+), 29 deletions(-)

diff --git a/scripts/hulk.js b/scripts/hulk.js
index 5a793c18..a4b1a4d5 100755
--- a/scripts/hulk.js
+++ b/scripts/hulk.js
@@ -173,11 +173,11 @@ function namespace(name) {
 // write a template foreach file that matches template extension
 templates = extractFiles(options.argv.remain)
   .map(function(file) {
-    var openedFile = fs.readFileSync(file, 'utf-8');
+    var openedFile = fs.readFileSync(file, 'utf-8').trim();
     var name;
     if (!openedFile) return;
     name = namespace(path.basename(file).replace(/\..*$/, ''));
-    openedFile = removeByteOrderMark(openedFile.trim());
+    openedFile = removeByteOrderMark(openedFile);
     openedFile = wrap(file, name, openedFile);
     if (!options.outputdir) return openedFile;
     fs.writeFileSync(path.join(options.outputdir, name + '.js')
diff --git a/src/diff2html.js b/src/diff2html.js
index 21b0119e..64e138f5 100644
--- a/src/diff2html.js
+++ b/src/diff2html.js
@@ -7,7 +7,6 @@

 (function() {
   var diffParser = require('./diff-parser.js').DiffParser;
-  var fileLister = require('./file-list-printer.js').FileListPrinter;
   var htmlPrinter = require('./html-printer.js').HtmlPrinter;

   function Diff2Html() {
@@ -43,7 +42,7 @@

     var fileList = '';
     if (configOrEmpty.showFiles === true) {
-      fileList = fileLister.generateFileList(diffJson, configOrEmpty);
+      fileList = htmlPrinter.generateFileListSummary(diffJson, configOrEmpty);
     }

     var diffOutput = '';
diff --git a/src/file-list-printer.js b/src/file-list-printer.js
index e408d9b2..1e0a2c61 100644
--- a/src/file-list-printer.js
+++ b/src/file-list-printer.js
@@ -8,11 +8,16 @@
 (function() {
   var printerUtils = require('./printer-utils.js').PrinterUtils;

-  var hoganUtils = require('./hoganjs-utils.js').HoganJsUtils;
+  var hoganUtils;
+
   var baseTemplatesPath = 'file-summary';
   var iconsBaseTemplatesPath = 'icon';

-  function FileListPrinter() {
+  function FileListPrinter(config) {
+    this.config = config;
+
+    var HoganJsUtils = require('./hoganjs-utils.js').HoganJsUtils;
+    hoganUtils = new HoganJsUtils(config);
   }

   FileListPrinter.prototype.generateFileList = function(diffFiles) {
@@ -38,5 +43,5 @@
     });
   };

-  module.exports.FileListPrinter = new FileListPrinter();
+  module.exports.FileListPrinter = FileListPrinter;
 })();
diff --git a/src/hoganjs-utils.js b/src/hoganjs-utils.js
index 9949e5fa..0dda08d7 100644
--- a/src/hoganjs-utils.js
+++ b/src/hoganjs-utils.js
@@ -8,18 +8,19 @@
 (function() {
   var fs = require('fs');
   var path = require('path');
-
   var hogan = require('hogan.js');

   var hoganTemplates = require('./templates/diff2html-templates.js');

-  var templatesPath = path.resolve(__dirname, 'templates');
+  var extraTemplates;

-  function HoganJsUtils() {
+  function HoganJsUtils(configuration) {
+    this.config = configuration || {};
+    extraTemplates = this.config.templates || {};
   }

-  HoganJsUtils.prototype.render = function(namespace, view, params, configuration) {
-    var template = this.template(namespace, view, configuration);
+  HoganJsUtils.prototype.render = function(namespace, view, params) {
+    var template = this.template(namespace, view);
     if (template) {
       return template.render(params);
     }
@@ -27,17 +28,16 @@
     return null;
   };

-  HoganJsUtils.prototype.template = function(namespace, view, configuration) {
-    var config = configuration || {};
+  HoganJsUtils.prototype.template = function(namespace, view) {
     var templateKey = this._templateKey(namespace, view);

-    return this._getTemplate(templateKey, config);
+    return this._getTemplate(templateKey);
   };

-  HoganJsUtils.prototype._getTemplate = function(templateKey, config) {
+  HoganJsUtils.prototype._getTemplate = function(templateKey) {
     var template;

-    if (!config.noCache) {
+    if (!this.config.noCache) {
       template = this._readFromCache(templateKey);
     }

@@ -53,6 +53,7 @@

     try {
       if (fs.readFileSync) {
+        var templatesPath = path.resolve(__dirname, 'templates');
         var templatePath = path.join(templatesPath, templateKey);
         var templateContent = fs.readFileSync(templatePath + '.mustache', 'utf8');
         template = hogan.compile(templateContent);
@@ -66,12 +67,16 @@
   };

   HoganJsUtils.prototype._readFromCache = function(templateKey) {
-    return hoganTemplates[templateKey];
+    return extraTemplates[templateKey] || hoganTemplates[templateKey];
   };

   HoganJsUtils.prototype._templateKey = function(namespace, view) {
     return namespace + '-' + view;
   };

-  module.exports.HoganJsUtils = new HoganJsUtils();
+  HoganJsUtils.prototype.compile = function(templateStr) {
+    return hogan.compile(templateStr);
+  };
+
+  module.exports.HoganJsUtils = HoganJsUtils;
 })();
diff --git a/src/html-printer.js b/src/html-printer.js
index 585d5b66..13f83047 100644
--- a/src/html-printer.js
+++ b/src/html-printer.js
@@ -8,6 +8,7 @@
 (function() {
   var LineByLinePrinter = require('./line-by-line-printer.js').LineByLinePrinter;
   var SideBySidePrinter = require('./side-by-side-printer.js').SideBySidePrinter;
+  var FileListPrinter = require('./file-list-printer.js').FileListPrinter;

   function HtmlPrinter() {
   }
@@ -22,5 +23,10 @@
     return sideBySidePrinter.generateSideBySideJsonHtml(diffFiles);
   };

+  HtmlPrinter.prototype.generateFileListSummary = function(diffJson, config) {
+    var fileListPrinter = new FileListPrinter(config);
+    return fileListPrinter.generateFileList(diffJson);
+  };
+
   module.exports.HtmlPrinter = new HtmlPrinter();
 })();
diff --git a/src/line-by-line-printer.js b/src/line-by-line-printer.js
index b07eb53c..d230bedd 100644
--- a/src/line-by-line-printer.js
+++ b/src/line-by-line-printer.js
@@ -11,7 +11,8 @@
   var utils = require('./utils.js').Utils;
   var Rematch = require('./rematch.js').Rematch;

-  var hoganUtils = require('./hoganjs-utils.js').HoganJsUtils;
+  var hoganUtils;
+
   var genericTemplatesPath = 'generic';
   var baseTemplatesPath = 'line-by-line';
   var iconsBaseTemplatesPath = 'icon';
@@ -19,6 +20,9 @@

   function LineByLinePrinter(config) {
     this.config = config;
+
+    var HoganJsUtils = require('./hoganjs-utils.js').HoganJsUtils;
+    hoganUtils = new HoganJsUtils(config);
   }

   LineByLinePrinter.prototype.makeFileDiffHtml = function(file, diffs) {
diff --git a/src/side-by-side-printer.js b/src/side-by-side-printer.js
index bbf1dc8d..5e3033b3 100644
--- a/src/side-by-side-printer.js
+++ b/src/side-by-side-printer.js
@@ -11,7 +11,8 @@
   var utils = require('./utils.js').Utils;
   var Rematch = require('./rematch.js').Rematch;

-  var hoganUtils = require('./hoganjs-utils.js').HoganJsUtils;
+  var hoganUtils;
+
   var genericTemplatesPath = 'generic';
   var baseTemplatesPath = 'side-by-side';
   var iconsBaseTemplatesPath = 'icon';
@@ -26,6 +27,9 @@

   function SideBySidePrinter(config) {
     this.config = config;
+
+    var HoganJsUtils = require('./hoganjs-utils.js').HoganJsUtils;
+    hoganUtils = new HoganJsUtils(config);
   }

   SideBySidePrinter.prototype.makeDiffHtml = function(file, diffs) {
diff --git a/test/file-list-printer-tests.js b/test/file-list-printer-tests.js
index a502a46f..60ea3208 100644
--- a/test/file-list-printer-tests.js
+++ b/test/file-list-printer-tests.js
@@ -1,6 +1,6 @@
 var assert = require('assert');

-var fileListPrinter = require('../src/file-list-printer.js').FileListPrinter;
+var fileListPrinter = new (require('../src/file-list-printer.js').FileListPrinter)();

 describe('FileListPrinter', function() {
   describe('generateFileList', function() {
diff --git a/test/hogan-cache-tests.js b/test/hogan-cache-tests.js
index 190bf6f8..3bb754ac 100644
--- a/test/hogan-cache-tests.js
+++ b/test/hogan-cache-tests.js
@@ -1,6 +1,6 @@
 var assert = require('assert');

-var HoganJsUtils = require('../src/hoganjs-utils.js').HoganJsUtils;
+var HoganJsUtils = new (require('../src/hoganjs-utils.js').HoganJsUtils)();
 var diffParser = require('../src/diff-parser.js').DiffParser;

 describe('HoganJsUtils', function() {
@@ -21,16 +21,28 @@ describe('HoganJsUtils', function() {
       });
       assert.equal(emptyDiffHtml, result);
     });
+
     it('should render view without cache', function() {
       var result = HoganJsUtils.render('generic', 'empty-diff', {
         contentClass: 'd2h-code-line',
         diffParser: diffParser
       }, {noCache: true});
-      assert.equal(emptyDiffHtml + '\n', result);
+      assert.equal(emptyDiffHtml, result);
     });
+
     it('should return null if template is missing', function() {
-      var result = HoganJsUtils.render('generic', 'missing-template', {}, {noCache: true});
+      var hoganUtils = new (require('../src/hoganjs-utils.js').HoganJsUtils)({noCache: true});
+      var result = hoganUtils.render('generic', 'missing-template', {});
       assert.equal(null, result);
     });
+
+    it('should allow templates to be overridden', function() {
+      var emptyDiffTemplate = HoganJsUtils.compile('&lt;p&gt;&lt;/p&gt;');
+
+      var config = {templates: {'generic-empty-diff': emptyDiffTemplate}};
+      var hoganUtils = new (require('../src/hoganjs-utils.js').HoganJsUtils)(config);
+      var result = hoganUtils.render('generic', 'empty-diff', {myName: 'Rodrigo Fernandes'});
+      assert.equal('&lt;p&gt;Rodrigo Fernandes&lt;/p&gt;', result);
+    });
   });
 });
diff --git a/test/line-by-line-tests.js b/test/line-by-line-tests.js
index 1cd92073..8869b3df 100644
--- a/test/line-by-line-tests.js
+++ b/test/line-by-line-tests.js
@@ -14,7 +14,7 @@ describe('LineByLinePrinter', function() {
         '            File without changes\n' +
         '        &lt;/div&gt;\n' +
         '    &lt;/td&gt;\n' +
-        '&lt;/tr&gt;\n';
+        '&lt;/tr&gt;';

       assert.equal(expected, fileHtml);
     });
@@ -422,7 +422,6 @@ describe('LineByLinePrinter', function() {
         '        &lt;/div&gt;\n' +
         '    &lt;/td&gt;\n' +
         '&lt;/tr&gt;\n' +
-        '\n' +
         '                &lt;/tbody&gt;\n' +
         '            &lt;/table&gt;\n' +
         '        &lt;/div&gt;\n' +
diff --git a/test/side-by-side-printer-tests.js b/test/side-by-side-printer-tests.js
index 76625f8e..771daaa5 100644
--- a/test/side-by-side-printer-tests.js
+++ b/test/side-by-side-printer-tests.js
@@ -14,7 +14,7 @@ describe('SideBySidePrinter', function() {
         '            File without changes\n' +
         '        &lt;/div&gt;\n' +
         '    &lt;/td&gt;\n' +
-        '&lt;/tr&gt;\n';
+        '&lt;/tr&gt;';

       assert.equal(expectedRight, fileHtml.right);
       assert.equal(expectedLeft, fileHtml.left);
@@ -324,7 +324,6 @@ describe('SideBySidePrinter', function() {
         '        &lt;/div&gt;\n' +
         '    &lt;/td&gt;\n' +
         '&lt;/tr&gt;\n' +
-        '\n' +
         '                    &lt;/tbody&gt;\n' +
         '                &lt;/table&gt;\n' +
         '            &lt;/div&gt;\n' +

From f3cadb96677d0eb82fc2752dc3ffbf35ca9b5bdb Mon Sep 17 00:00:00 2001
From: Rodrigo Fernandes &lt;rtfrodrigo@gmail.com&gt;
Date: Sat, 15 Oct 2016 13:21:22 +0100
Subject: [PATCH 2/2] Allow uncompiled templates

---
 README.md                 |  3 +++
 src/hoganjs-utils.js      |  7 +++++++
 test/hogan-cache-tests.js | 24 +++++++++++++++++++++++-
 3 files changed, 33 insertions(+), 1 deletion(-)

diff --git a/README.md b/README.md
index 132c8a28..46909f25 100644
--- a/README.md
+++ b/README.md
@@ -98,6 +98,9 @@ The HTML output accepts a Javascript object with configuration. Possible options
   - `synchronisedScroll`: scroll both panes in side-by-side mode: `true` or `false`, default is `false`
   - `matchWordsThreshold`: similarity threshold for word matching, default is 0.25
   - `matchingMaxComparisons`: perform at most this much comparisons for line matching a block of changes, default is `2500`
+  - `templates`: object with previously compiled templates to replace parts of the html
+  - `rawTemplates`: object with raw not compiled templates to replace parts of the html
+  &gt; For more information regarding the possible templates look into [src/templates](https://github.com/rtfpessoa/diff2html/tree/master/src/templates)

 ## Diff2HtmlUI Helper

diff --git a/src/hoganjs-utils.js b/src/hoganjs-utils.js
index 0dda08d7..b2e9c275 100644
--- a/src/hoganjs-utils.js
+++ b/src/hoganjs-utils.js
@@ -17,6 +17,13 @@
   function HoganJsUtils(configuration) {
     this.config = configuration || {};
     extraTemplates = this.config.templates || {};
+
+    var rawTemplates = this.config.rawTemplates || {};
+    for (var templateName in rawTemplates) {
+      if (rawTemplates.hasOwnProperty(templateName)) {
+        if (!extraTemplates[templateName]) extraTemplates[templateName] = this.compile(rawTemplates[templateName]);
+      }
+    }
   }

   HoganJsUtils.prototype.render = function(namespace, view, params) {
diff --git a/test/hogan-cache-tests.js b/test/hogan-cache-tests.js
index 3bb754ac..a34839c0 100644
--- a/test/hogan-cache-tests.js
+++ b/test/hogan-cache-tests.js
@@ -36,7 +36,7 @@ describe('HoganJsUtils', function() {
       assert.equal(null, result);
     });

-    it('should allow templates to be overridden', function() {
+    it('should allow templates to be overridden with compiled templates', function() {
       var emptyDiffTemplate = HoganJsUtils.compile('&lt;p&gt;&lt;/p&gt;');

       var config = {templates: {'generic-empty-diff': emptyDiffTemplate}};
@@ -44,5 +44,27 @@ describe('HoganJsUtils', function() {
       var result = hoganUtils.render('generic', 'empty-diff', {myName: 'Rodrigo Fernandes'});
       assert.equal('&lt;p&gt;Rodrigo Fernandes&lt;/p&gt;', result);
     });
+
+    it('should allow templates to be overridden with uncompiled templates', function() {
+      var emptyDiffTemplate = '&lt;p&gt;&lt;/p&gt;';
+
+      var config = {rawTemplates: {'generic-empty-diff': emptyDiffTemplate}};
+      var hoganUtils = new (require('../src/hoganjs-utils.js').HoganJsUtils)(config);
+      var result = hoganUtils.render('generic', 'empty-diff', {myName: 'Rodrigo Fernandes'});
+      assert.equal('&lt;p&gt;Rodrigo Fernandes&lt;/p&gt;', result);
+    });
+
+    it('should allow templates to be overridden giving priority to compiled templates', function() {
+      var emptyDiffTemplate = HoganJsUtils.compile('&lt;p&gt;&lt;/p&gt;');
+      var emptyDiffTemplateUncompiled = '&lt;p&gt;Not used!&lt;/p&gt;';
+
+      var config = {
+        templates: {'generic-empty-diff': emptyDiffTemplate},
+        rawTemplates: {'generic-empty-diff': emptyDiffTemplateUncompiled}
+      };
+      var hoganUtils = new (require('../src/hoganjs-utils.js').HoganJsUtils)(config);
+      var result = hoganUtils.render('generic', 'empty-diff', {myName: 'Rodrigo Fernandes'});
+      assert.equal('&lt;p&gt;Rodrigo Fernandes&lt;/p&gt;', result);
+    });
   });
 });
</code></pre>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="code"/><summary type="html"><![CDATA[this is how you can display code diffs]]></summary></entry><entry><title type="html">a post with advanced image components</title><link href="https://peng00bo00.github.io/blog/2024/advanced-images/" rel="alternate" type="text/html" title="a post with advanced image components"/><published>2024-01-27T11:46:00+00:00</published><updated>2024-01-27T11:46:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/advanced-images</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/advanced-images/"><![CDATA[<p>This is an example post with advanced image components.</p> <h2 id="image-slider">Image Slider</h2> <p>This is a simple image slider. It uses the <a href="https://swiperjs.com/">Swiper</a> library. Check the <a href="https://swiperjs.com/demos">examples page</a> for more information of what you can achieve with it.</p> <swiper-container keyboard="true" navigation="true" pagination="true" pagination-clickable="true" pagination-dynamic-bullets="true" rewind="true"> <swiper-slide> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/9-480.webp 480w,/assets/img/9-800.webp 800w,/assets/img/9-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/9.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </swiper-slide> <swiper-slide> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/7-480.webp 480w,/assets/img/7-800.webp 800w,/assets/img/7-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/7.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </swiper-slide> <swiper-slide> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/8-480.webp 480w,/assets/img/8-800.webp 800w,/assets/img/8-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/8.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </swiper-slide> <swiper-slide> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/10-480.webp 480w,/assets/img/10-800.webp 800w,/assets/img/10-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/10.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </swiper-slide> <swiper-slide> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/12-480.webp 480w,/assets/img/12-800.webp 800w,/assets/img/12-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/12.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </swiper-slide> </swiper-container> <h2 id="image-comparison-slider">Image Comparison Slider</h2> <p>This is a simple image comparison slider. It uses the <a href="https://img-comparison-slider.sneas.io/">img-comparison-slider</a> library. Check the <a href="https://img-comparison-slider.sneas.io/examples.html">examples page</a> for more information of what you can achieve with it.</p> <img-comparison-slider> <figure slot="first"> <picture> <source class="responsive-img-srcset" srcset="/assets/img/prof_pic-480.webp 480w,/assets/img/prof_pic-800.webp 800w,/assets/img/prof_pic-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/prof_pic.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figure slot="second"> <picture> <source class="responsive-img-srcset" srcset="/assets/img/prof_pic_color-480.webp 480w,/assets/img/prof_pic_color-800.webp 800w,/assets/img/prof_pic_color-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/prof_pic_color.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </img-comparison-slider>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="images"/><summary type="html"><![CDATA[this is what advanced image components could look like]]></summary></entry><entry><title type="html">a post with vega lite</title><link href="https://peng00bo00.github.io/blog/2024/vega-lite/" rel="alternate" type="text/html" title="a post with vega lite"/><published>2024-01-27T00:20:00+00:00</published><updated>2024-01-27T00:20:00+00:00</updated><id>https://peng00bo00.github.io/blog/2024/vega-lite</id><content type="html" xml:base="https://peng00bo00.github.io/blog/2024/vega-lite/"><![CDATA[<p>This is an example post with some <a href="https://vega.github.io/vega-lite/">vega lite</a> code.</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="p">```</span><span class="nl">vega_lite
</span><span class="sb">{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "A dot plot showing each movie in the database, and the difference from the average movie rating. The display is sorted by year to visualize everything in sequential order. The graph is for all Movies before 2019.",
  "data": {
    "url": "https://raw.githubusercontent.com/vega/vega/main/docs/data/movies.json"
  },
  "transform": [
    {"filter": "datum['IMDB Rating'] != null"},
    {"filter": {"timeUnit": "year", "field": "Release Date", "range": [null, 2019]}},
    {
      "joinaggregate": [{
        "op": "mean",
        "field": "IMDB Rating",
        "as": "AverageRating"
      }]
    },
    {
      "calculate": "datum['IMDB Rating'] - datum.AverageRating",
      "as": "RatingDelta"
    }
  ],
  "mark": "point",
  "encoding": {
    "x": {
      "field": "Release Date",
      "type": "temporal"
    },
    "y": {
      "field": "RatingDelta",
      "type": "quantitative",
      "title": "Rating Delta"
    },
    "color": {
      "field": "RatingDelta",
      "type": "quantitative",
      "scale": {"domainMid": 0},
      "title": "Rating Delta"
    }
  }
}</span>
<span class="p">```</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Which generates:</p> <pre><code class="language-vega_lite">{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "A dot plot showing each movie in the database, and the difference from the average movie rating. The display is sorted by year to visualize everything in sequential order. The graph is for all Movies before 2019.",
  "data": {
    "url": "https://raw.githubusercontent.com/vega/vega/main/docs/data/movies.json"
  },
  "transform": [
    {"filter": "datum['IMDB Rating'] != null"},
    {"filter": {"timeUnit": "year", "field": "Release Date", "range": [null, 2019]}},
    {
      "joinaggregate": [{
        "op": "mean",
        "field": "IMDB Rating",
        "as": "AverageRating"
      }]
    },
    {
      "calculate": "datum['IMDB Rating'] - datum.AverageRating",
      "as": "RatingDelta"
    }
  ],
  "mark": "point",
  "encoding": {
    "x": {
      "field": "Release Date",
      "type": "temporal"
    },
    "y": {
      "field": "RatingDelta",
      "type": "quantitative",
      "title": "Rating Delta"
    },
    "color": {
      "field": "RatingDelta",
      "type": "quantitative",
      "scale": {"domainMid": 0},
      "title": "Rating Delta"
    }
  }
}
</code></pre> <p>This plot supports both light and dark themes.</p>]]></content><author><name></name></author><category term="sample-posts"/><category term="formatting"/><category term="charts"/><summary type="html"><![CDATA[this is what included vega lite code could look like]]></summary></entry></feed>